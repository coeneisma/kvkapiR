---
title: "kvkapiR"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Check if API key is available for conditional chunk execution
has_api_key <- nzchar(Sys.getenv("KVK_API_KEY"))
```

The goal of kvkapiR is to provide a convenient R programming language interface to the Dutch Chamber of Commerce (KvK) APIs. This package is built using the httr2 package and follows best practices for wrapping APIs in R, as outlined in the [httr2 documentation](https://httr2.r-lib.org/articles/wrapping-apis.html). It simplifies authentication, request handling, and response parsing when interacting with the KvK API.

The package provides access to [all the KvK APIs](https://developers.kvk.nl/documentation#available-apis):

* KvK Search API
* KvK Basisprofiel API
* KvK Vestigingsprofiel API
* KvK Naamgeving API

More details on the API can be found [on the developers website of the KvK](https://developers.kvk.nl/apis).

**📋 Important Note:** This package is developed independently and is not officially affiliated with or endorsed by the Dutch Chamber of Commerce (Kamer van Koophandel). It provides an unofficial interface to their public APIs.

## Loading the package

```{r}
library(kvkapiR)
```

## API keys

```{r, echo = FALSE, results = 'asis'}
if (!has_api_key) {
  cat("**Note:** No API key was found. The production API examples below will not be executed. ")
  cat("To run all examples, please set your API key using `kvk_set_api_key()` or the test environment examples will still work.")
}
```

### Optaining an API key

To access the KvK API, you need an API key. You can apply for an API key and learn about different KvK APIs on the [KvK Developer Portal](https://developers.kvk.nl/apply-for-apis?step=api-overview).

### Temporary API Key (Current Session Only)

If you only need an API key for the current session, use the `kvk_set_api_key()` function. 

``` r
kvk_set_api_key(api_key = "your_api_key_here")
```

**⚠️ Note:** This only sets the key for the current R session. The key will be lost once you restart R.

### Persistent API Key (Stored in `.Renviron`)

If you want to store the API key permanently, use the `kvk_store_api_key()` function. This saves the key in the `.Renviron` file, making it persist across R sessions.

``` r
kvk_store_api_key(api_key = "your_api_key_here")
```
To update an existing API key, set the `overwrite` parameter to `TRUE`:

``` r 
kvk_store_api_key(api_key = "your_new_api_key", overwrite = TRUE)
```
**⚠️ Important:** You must restart R for the changes to take effect.

**⚠️ Warning:** Only use this method if you can safely store your API key on your system.


## Search the KvK API

The `kvk_search()` function is wrapper for the KvK Search API. It automatically paginates results (up to 1,000 records).

Below are examples demonstrating how to perform searches and handle API responses.

### Example 1: single variable, less then 1.000 records

Lets search for KvK registrations in [the village of Koudum](https://nl.wikipedia.org/wiki/Koudum). Since this is a small village with fewer than *1.000* registered businesses (the API limit), all records are retrieved in one request.

```{r, eval = has_api_key}
koudum <- kvk_search(plaats = "Koudum")
koudum
```


### Example 2: single variable, more then 1.000 records

The [city of Rotterdam](https://nl.wikipedia.org/wiki/Rotterdam) is significantly larger than Koudum. Searching for all registrations in Rotterdam will return more than 1,000 records, exceeding the API limit. 
When this happens, a warning is displayed:

```{r, eval = has_api_key}
rotterdam <- kvk_search(plaats = "Rotterdam")
rotterdam
```

### Example 3: combining multiple search terms in variables

You can combine multiple search terms in any parameter to refine your search. The API treats multiple words within a parameter as an AND operation by default.

```{r, eval = has_api_key}
# Search for businesses with both "snackbar" and "hoekje" in their name
snackbar_hoekje <- kvk_search(naam = "snackbar hoekje")
snackbar_hoekje
```



### Example 4: Searching with Multiple Criteria

You can combine multiple search criteria in a query.

For example, let's search for businesses in Utrecht where the name contains both `snackbar` and `hoek`:

```{r, eval = has_api_key}
snackbar <- kvk_search(plaats = "Utrecht", naam = "snackbar")
snackbar
```

### Example 5: Filtering by Business Type

The API allows filtering by business type using the `type` parameter. You can search for:

- `hoofdvestiging` (main branch)
- `nevenvestiging` (secondary branch)  
- `rechtspersoon` (legal entity)

You can also combine multiple types by passing the `type` parameter multiple times:

```{r, eval = has_api_key}
# Search for both main branches AND legal entities in Amsterdam
mixed_types <- kvk_search(
  plaats = "Amsterdam",
  type = "hoofdvestiging",
  type = "rechtspersoon"
)
mixed_types
```

### Example 6: Search by Address

You can search for businesses at a specific address using different combinations:

#### Full address search (postcode + house number):
```{r, eval = has_api_key}
# Search businesses at a specific address
secret_address <- kvk_search(postcode = "2594BD", huisnummer = "10")
secret_address
```

#### Street name only search:
```{r, eval = has_api_key}
# Search all businesses on a specific street
street_businesses <- kvk_search(straatnaam = "Bezuidenhoutseweg", plaats = "Den Haag")
street_businesses
```

## Retrieving Profile Data

The package provides functions to retrieve three types of detailed profiles from the API:

* **Basisprofiel** (Basic Profile) - General company information
* **Vestigingsprofiel** (Establishment Profile) - Detailed branch/location information
* **Naamgeving** (Name History) - Historical company names

**💰 Note:** Each profile retrieval costs EUR 0.02 per call (except for government organizations - see below).

### Production Examples

Here we retrieve real data from the production API:

#### Basisprofiel

The basic profile contains general company information:

```{r, eval = has_api_key}
# Get basic profile for a social organization (Stichting Gemeenschapscentrum Koudum)
stichting_profile <- kvk_get_basisprofiel(kvkNummer = "01036576")
stichting_profile
```

#### Vestigingsprofiel

The establishment profile provides detailed information about a specific location, including geographical data:

```{r, eval = has_api_key}
# Get establishment profile for the same organization
stichting_vestiging <- kvk_get_vestigingsprofiel(vestigingsnummer = "000007810083")
stichting_vestiging

# The vestigingsprofiel contains geographical data for mapping and analysis
# Access coordinates through the nested 'adressen' column:
if (nrow(stichting_vestiging) > 0 && length(stichting_vestiging$adressen[[1]]) > 0) {
  address_data <- stichting_vestiging$adressen[[1]]
  if ("geoData" %in% names(address_data)) {
    geo_info <- address_data$geoData
    cat("Geographical coordinates available for mapping and spatial analysis\n")
  }
}
```

#### Naamgeving

The name history shows all historical names of a company:

```{r, eval = has_api_key}
# Get name history
stichting_names <- kvk_get_naamgeving(kvkNummer = "01036576")
stichting_names
```


## Usage Tracking and Cost Management

The kvkapiR package includes automatic usage tracking to help you monitor API calls and costs.

### View Usage Report

Use `kvk_usage_report()` to see your API usage and costs in multiple formats:

```{r}
# View summary report (default format)
kvk_usage_report()

# Get detailed tibble format for data analysis
usage_data <- kvk_usage_report(format = "tibble")
usage_data

# Get tidy format for visualization and analysis
usage_tidy <- kvk_usage_report(format = "tidy")
usage_tidy

# View specific month
kvk_usage_report(year = 2025, month = 6)
```

The different output formats serve different purposes:

- **"summary"** (default): Human-readable overview with costs and totals
- **"tibble"**: Structured data frame for analysis, one row per month
- **"tidy"**: Long format with one row per API call, perfect for creating visualizations

The report shows:

- Monthly base fee: EUR 6.20
- Per-query costs: EUR 0.02 for profile retrievals (search is free)
- Total costs and call counts by type

### Set Usage Alerts

Protect against unexpected costs with usage alerts:

```{r}
# Set monthly cost limit of EUR 25
kvk_usage_alert(max_cost = 25, period = "month")

# Set call count limit
kvk_usage_alert(max_calls = 500, period = "month")

# Set yearly limit
kvk_usage_alert(max_cost = 300, period = "year")
```

When limits are exceeded, you'll see:

- **First alert**: Warning when limit is reached
- **Reminder alerts**: Notifications for continued usage over limits

### Export Usage Data

Export your usage history for external analysis:

```{r, eval = FALSE}
# Export as tidy format (one row per call)
kvk_export_usage("my_usage.csv", format = "tidy")

# Export as monthly summary
kvk_export_usage("monthly_summary.csv", format = "monthly")
```

### Usage Tracking Privacy and Control

**Privacy-First Design**: kvkapiR respects your privacy with the following safeguards:

- **Opt-in Only**: You'll be asked for permission before any tracking begins
- **Local Storage**: All data stays on your computer (in your user directory)
- **No External Transmission**: Nothing is sent to external servers
- **Easy to Disable**: Multiple ways to turn off tracking

**First Time Setup**: When you make your first API call, you'll see:
```
Enable usage tracking? (yes/no):
```

**Control Options**:

```{r, eval = FALSE}
# Permanently disable tracking
Sys.setenv(KVKAPI_DISABLE_TRACKING = "true")

# Enable tracking programmatically
options(kvkapiR.usage_tracking_opted_in = TRUE)

# Disable tracking programmatically  
options(kvkapiR.usage_tracking_opted_in = FALSE)
```

**Data Location**: Usage data is stored in your user directory using `tools::R_user_dir("kvkapiR", "data")` for R 4.0+ or `~/.kvkapiR/` for older versions.

## Cost Information

**⚠️ Important:** The costs mentioned below are charged by the Dutch Chamber of Commerce (KvK) for API usage. These costs may change in the future, and any updates will be reflected in future versions of this package.

### Pricing Structure

- **Monthly base fee**: EUR 6.20 (charged if any API calls are made)
- **Search API**: Free
- **Profile APIs**: EUR 0.02 per call (basisprofiel, vestigingsprofiel, naamgeving)

### Government Organizations

Government organizations are exempt from all API costs and can use all APIs without incurring charges.

## Test Environment

KvK provides a test environment where you can experiment with the API before using it in production. More information is available on the [KvK documentation page](https://developers.kvk.nl/documentation/testing).

All search and profile retrieval functions in `kvkapiR` support testing mode via the `test_environment` argument, which is set to `FALSE` by default.

**🦆 Tip:** The test environment contains fictional data based on characters from the Dutch comic magazine "Donald Duck". Try searching for names like "Donald" and "Dagobert" to see how the API works with sample data.

The test environment:

- Uses a different base URL: `https://api.kvk.nl/test/api/`
- Contains fictional business data for testing purposes
- Does not require an API key (the package uses a built-in test key)
- Has the same functionality and endpoints as production
- Does not incur any costs
- Does not count towards usage tracking
- Displays informative messages for each API call, indicating test environment usage

**Note:** When using the test environment, each API call displays a message like:
```
ℹ You are using the KvK test environment. Test data will be returned.
```

### Test Environment Examples

```{r}
# Search in test environment - no API key needed
# Note: You'll see a message indicating test environment usage
test_results <- kvk_search(naam = "Donald", test_environment = TRUE)
test_results

# Get test profiles - no costs incurred
donald <- kvk_search(naam = "Donald", test_environment = TRUE)
test_basisprofiel <- kvk_get_basisprofiel(
  kvkNummer = donald$kvkNummer[1], 
  test_environment = TRUE
)
test_basisprofiel

test_vestigingsprofiel <- kvk_get_vestigingsprofiel(
  vestigingsnummer = donald$vestigingsnummer[1], 
  test_environment = TRUE
)
test_vestigingsprofiel

test_naamgeving <- kvk_get_naamgeving(
  kvkNummer = donald$kvkNummer[1], 
  test_environment = TRUE
)
test_naamgeving
```

## Conclusion

The `kvkapiR` package provides a comprehensive interface for accessing KvK business data in R with:

- Simple authentication management
- Full API coverage (search and profile retrieval)
- Test environment support for development
- Automatic usage tracking and cost monitoring
- Flexible search options including multiple filters
- Government organization fee exemption

For more details, refer to the official [KvK API documentation](https://developers.kvk.nl/apis).
